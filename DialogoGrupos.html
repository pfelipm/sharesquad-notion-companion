<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Cargar Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      body { padding: 1rem; }
      #group-list { max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; padding: 0.5rem; border-radius: 0.375rem; }
      #loading-spinner { display: none; }
    </style>
  </head>
  <body>
    <!-- 
      Scriptlet de inyección de JSON (método robusto)
      Inyecta las traducciones ('t') y la config ('CONFIG') como strings JSON.
    -->
    <script>
      const t = <?!= t ?>;
      const CONFIG = <?!= CONFIG ?>;
    </script>
    
    <!-- Contenedor para Alertas -->
    <div id="alert-container"></div>

    <p id="instructions"><!-- Se rellenará con JS --></p>
    <!-- NUEVO PÁRRAFO DE ADVERTENCIA -->
    <p class="text-muted small" id="warning-nested"><!-- Se rellenará con JS --></p>

    <!-- Lista de Grupos -->
    <div id="group-list-loading" class="text-center">
      <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <span id="loading-groups-text" class="ms-2"><!-- Se rellenará con JS --></span>
    </div>
    <div id="group-list">
      <!-- Los checkboxes se insertarán aquí -->
    </div>

    <!-- Spinner de Carga Principal (para importación) -->
    <div id="loading-spinner" class="text-center my-3">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Botones de Acción -->
    <footer class="mt-3 text-end">
      <button type="button" class="btn btn-secondary" id="btn-close"><!-- Se rellenará con JS --></button>
      <button type="button" class="btn btn-primary" id="btn-import">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
        <span id="btn-import-text"><!-- Se rellenará con JS --></span>
      </button>
    </footer>

    <!-- JS del Cliente -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // --- 1. Aplicar Traducciones ---
        document.getElementById("instructions").innerText = t.importInstructions;
        document.getElementById("warning-nested").innerText = t.importWarningNested;
        document.getElementById("loading-groups-text").innerText = t.importLoadingGroups;
        document.getElementById("btn-close").innerText = t.close;
        document.getElementById("btn-import-text").innerText = t.importButton;

        // --- 2. Handlers de Botones ---
        document.getElementById("btn-close").addEventListener("click", () => {
          google.script.host.close();
        });

        document.getElementById("btn-import").addEventListener("click", handleImport);

        // --- 3. Cargar Grupos ---
        google.script.run
          .withSuccessHandler(mostrarGrupos)
          .withFailureHandler(handleInitialError) // <-- ¡CORRECCIÓN! Usar el nuevo handler
          .obtenerGruposDeUsuario();
      });

      /** * Nuevo handler de error para la carga inicial.
       * Oculta el spinner de carga y muestra el error.
       */
      function handleInitialError(error) {
        document.getElementById("group-list-loading").style.display = "none";
        // Asegurarse de que 'error' es un string, ya que puede ser un objeto
        const errorMessage = error.message ? error.message : (typeof error === 'object' ? JSON.stringify(error) : error);
        mostrarAlerta(errorMessage, "danger");
      }

      /** Muestra la lista de grupos como checkboxes */
      function mostrarGrupos(groups) {
        document.getElementById("group-list-loading").style.display = "none";
        
        if (groups.error) {
          // 'groups.error' ya es un string localizado desde el servidor
          mostrarAlerta(groups.error);
          return;
        }

        const listContainer = document.getElementById("group-list");
        if (groups.length === 0) {
          listContainer.innerText = t.errorGetGroups;
          return;
        }

        groups.forEach(group => {
          const div = document.createElement("div");
          div.className = "form-check";
          // --- MODIFICACIÓN: Mostrar solo el email para evitar redundancia ---
          div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${group.email}" id="chk-${group.email}">
            <label class="form-check-label" for="chk-${group.email}">
              ${group.email}
            </label>
          `;
          listContainer.appendChild(div);
        });
      }

      /** Maneja el clic en "Importar" */
      function handleImport() {
        mostrarCarga(true);
        const selectedEmails = [];
        document.querySelectorAll("#group-list input[type='checkbox']:checked").forEach(chk => {
          selectedEmails.push(chk.value);
        });

        if (selectedEmails.length === 0) {
          mostrarAlerta(t.errorNoGroupsSelected); // <-- ¡CORRECCIÓN! Llamar a mostrarAlerta
          mostrarCarga(false);
          return;
        }

        google.script.run
          .withSuccessHandler(importacionFinalizada)
          .withFailureHandler(importacionFallida)
          .procesarGruposSeleccionados(selectedEmails);
      }

      /** Callback de éxito para la importación */
      function importacionFinalizada(result) {
        if (result.error) {
          importacionFallida({ message: result.error }); // Error de lógica del servidor
          return;
        }
        
        // Mostrar éxito y cerrar
        mostrarAlerta(result.message, "success");
        setTimeout(() => {
          google.script.host.close();
        }, 2000); // Cerrar tras 2 segundos
      }

      /** Callback de fallo para la importación */
      function importacionFallida(error) {
        mostrarCarga(false);
        // 'error.message' es la forma estándar de obtener el texto del error
        mostrarAlerta(error.message); // <-- ¡CORRECCIÓN! Llamar a mostrarAlerta
      }

      // --- Funciones de UI Auxiliares ---

      /** Muestra/oculta el spinner de carga principal */
      function mostrarCarga(isLoading) {
        document.getElementById("loading-spinner").style.display = isLoading ? "block" : "none";
        document.getElementById("btn-import").disabled = isLoading;
        document.getElementById("btn-close").disabled = isLoading;
      }

      /** Muestra una alerta de Bootstrap */
      function mostrarAlerta(message, type = "danger") {
        const container = document.getElementById("alert-container");
        container.innerHTML = `
          <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        // Usar Bootstrap para inicializar el descarte de la alerta
        new bootstrap.Alert(container.querySelector('.alert'));
      }

    </script>
    
    <!-- JS de Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  </body>
</html>