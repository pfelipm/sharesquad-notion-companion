<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Cargar Bootstrap 5 -->
    <!-- ¡CORRECCIÓN! Arreglado 'xintegrity' a 'integrity' -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      body { padding: 1rem; }
      #group-list { max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; padding: 0.5rem; border-radius: 0.375rem; }
      #loading-spinner { display: none; }
    </style>
  </head>
  <body>
    <!-- Contenedor para Alertas -->
    <div id="alert-container"></div>

    <p id="instructions"><!-- Se rellenará con JS --></p>

    <!-- Lista de Grupos -->
    <div id="group-list-loading" class="text-center">
      <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <span id="loading-groups-text" class="ms-2"><!-- Se rellenará con JS --></span>
    </div>
    <div id="group-list">
      <!-- Los checkboxes se insertarán aquí -->
    </div>

    <!-- Spinner de Carga Principal (para importación) -->
    <div id="loading-spinner" class="text-center my-3">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Botones de Acción -->
    <footer class="mt-3 text-end">
      <button type="button" class="btn btn-secondary" id="btn-close"><!-- Se rellenará con JS --></button>
      <button type="button" class="btn btn-primary" id="btn-import">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
        <span id="btn-import-text"><!-- Se rellenará con JS --></span>
      </button>
    </footer>

    <!-- JS del Cliente -->
    <script>
      // ¡CORRECCIÓN! Se inyectan las traducciones directamente con scriptlets <?= ... ?>
      document.addEventListener("DOMContentLoaded", function() {
        // --- 1. Aplicar Traducciones ---
        // Usamos el objeto 't' inyectado por el servidor
        document.getElementById("instructions").innerText = "<?!= t.importInstructions ?>";
        document.getElementById("loading-groups-text").innerText = "<?!= t.importLoadingGroups ?>";
        document.getElementById("btn-close").innerText = "<?!= t.close ?>";
        document.getElementById("btn-import-text").innerText = "<?!= t.importButton ?>";

        // --- 2. Handlers de Botones ---
        document.getElementById("btn-close").addEventListener("click", () => {
          google.script.host.close();
        });

        document.getElementById("btn-import").addEventListener("click", handleImport);

        // --- 3. Cargar Grupos ---
        google.script.run
          .withSuccessHandler(mostrarGrupos)
          .withFailureHandler(mostrarError)
          .obtenerGruposDeUsuario();
      });

      /** Muestra la lista de grupos como checkboxes */
      function mostrarGrupos(groups) {
        document.getElementById("group-list-loading").style.display = "none";
        
        if (groups.error) {
          mostrarError(groups.error);
          return;
        }

        const listContainer = document.getElementById("group-list");
        if (groups.length === 0) {
          listContainer.innerText = "<?!= t.errorGetGroups ?>"; // Usamos la traducción inyectada
          return;
        }

        groups.forEach(group => {
          const div = document.createElement("div");
          div.className = "form-check";
          div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${group.email}" id="chk-${group.email}">
            <label class="form-check-label" for="chk-${group.email}">
              ${group.name} (${group.email})
            </label>
          `;
          listContainer.appendChild(div);
        });
      }

      /** Maneja el clic en "Importar" */
      function handleImport() {
        mostrarCarga(true);
        const selectedEmails = [];
        document.querySelectorAll("#group-list input[type='checkbox']:checked").forEach(chk => {
          selectedEmails.push(chk.value);
        });

        if (selectedEmails.length === 0) {
          mostrarError("<?!= t.errorNoGroupsSelected ?>"); // Usamos la traducción inyectada
          mostrarCarga(false);
          return;
        }

        google.script.run
          .withSuccessHandler(importacionFinalizada)
          .withFailureHandler(importacionFallida)
          .procesarGruposSeleccionados(selectedEmails);
      }

      /** Callback de éxito para la importación */
      function importacionFinalizada(result) {
        if (result.error) {
          importacionFallida({ message: result.error }); // Error de lógica del servidor
          return;
        }
        
        // Mostrar éxito y cerrar
        mostrarAlerta(result.message, "success");
        setTimeout(() => {
          google.script.host.close();
        }, 2000); // Cerrar tras 2 segundos
      }

      /** Callback de fallo para la importación */
      function importacionFallida(error) {
        mostrarCarga(false);
        mostrarError(error.message);
      }

      // --- Funciones de UI Auxiliares ---

      /** Muestra/oculta el spinner de carga principal */
      function mostrarCarga(isLoading) {
        document.getElementById("loading-spinner").style.display = isLoading ? "block" : "none";
        document.getElementById("btn-import").disabled = isLoading;
        // Spinner en el botón
        const btnSpinner = document.querySelector("#btn-import .spinner-border");
        if (btnSpinner) btnSpinner.style.display = isLoading ? "inline-block" : "none";
      }

      /** Muestra un error en el contenedor de alertas */
      function mostrarError(message) {
        mostrarAlerta(message, "danger");
      }

      /** Muestra una alerta de Bootstrap */
      // ¡CORRECCIÓN! Convertido a ES5 (eliminado 'type = "danger"')
      function mostrarAlerta(message, type) {
        // Asegurar que 'type' tenga un valor por defecto
        var alertType = type || "danger"; 
        
        const container = document.getElementById("alert-container");
        container.innerHTML = `
          <div class="alert alert-${alertType} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        // Usar Bootstrap para inicializar el descarte de la alerta
        // Asegurarse de que 'bootstrap' esté cargado
        if (typeof bootstrap !== 'undefined') {
          // Intentar inicializar la alerta
          try {
            var alertNode = container.querySelector('.alert');
            if (alertNode) {
              new bootstrap.Alert(alertNode);
            }
          } catch (e) {
            console.error("Error al inicializar la alerta de Bootstrap:", e);
          }
        } else {
          console.error("Bootstrap no está cargado.");
        }
      }

    </script>
    
    <!-- JS de Bootstrap -->
    <!-- ¡CORRECCIÓN! Arreglado 'xintegrity' a 'integrity' -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  </body>
</html>